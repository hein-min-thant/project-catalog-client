<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI Chat Interface</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Marked.js library for Markdown rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
      body {
        font-family: "Inter", sans-serif;
        background-color: #f3f4f6;
      }
      .chat-container {
        max-width: 800px;
        margin: 2rem auto;
        border-radius: 1rem;
        box-shadow: 0 10px 25px -3px rgba(0, 0, 0, 0.1),
          0 4px 6px -2px rgba(0, 0, 0, 0.05);
        background-color: white;
        display: flex;
        flex-direction: column;
        height: calc(100vh - 4rem);
      }
      .chat-history {
        flex-grow: 1;
        padding: 1.5rem;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }
      .message {
        max-width: 75%;
        padding: 0.75rem 1rem;
        border-radius: 1rem;
        word-wrap: break-word;
      }
      .user-message {
        background-color: #3b82f6; /* Blue-500 */
        color: white;
        align-self: flex-end;
        border-bottom-right-radius: 0.25rem;
      }
      .ai-message {
        background-color: #e5e7eb; /* Gray-200 */
        color: #1f2937;
        align-self: flex-start;
        border-bottom-left-radius: 0.25rem;
        white-space: pre-wrap;
        /* Styling for markdown content */
      }
      .ai-message pre {
        background-color: #4b5563;
        color: white;
        padding: 0.5rem;
        border-radius: 0.5rem;
        overflow-x: auto;
      }
      .ai-message code {
        font-family: "Courier New", Courier, monospace;
      }
      .ai-message h1,
      .ai-message h2,
      .ai-message h3 {
        font-weight: bold;
        margin-top: 1em;
        margin-bottom: 0.5em;
      }
      .ai-message ul,
      .ai-message ol {
        margin-left: 1.5rem;
        list-style-type: disc;
      }
      .chat-form-container {
        padding: 1.5rem;
        border-top: 1px solid #e5e7eb;
        background-color: #f9fafb;
        border-bottom-left-radius: 1rem;
        border-bottom-right-radius: 1rem;
      }
      .input-group {
        display: flex;
        gap: 0.5rem;
      }
      .input-group input[type="text"] {
        flex-grow: 1;
        padding: 0.75rem;
        border-radius: 0.5rem;
        border: 1px solid #d1d5db;
      }
      .input-group button {
        padding: 0.75rem 1.5rem;
        background-color: #10b981; /* Green-500 */
        color: white;
        border-radius: 0.5rem;
        font-weight: 600;
        transition: background-color 0.2s;
      }
      .input-group button:hover {
        background-color: #059669; /* Green-600 */
      }
      .model-input-container {
        margin-top: 1rem;
      }
      .model-input-container label {
        display: block;
        font-weight: 600;
        color: #4b5563;
        margin-bottom: 0.25rem;
      }
      .typing-indicator {
        align-self: flex-start;
        padding: 0.75rem 1rem;
        background-color: #e5e7eb;
        color: #4b5563;
        border-radius: 1rem;
        border-bottom-left-radius: 0.25rem;
        animation: pulse 1.5s infinite;
      }
      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }
    </style>
  </head>
  <body class="antialiased">
    <div class="chat-container">
      <div class="chat-history" id="chat-history">
        <!-- Messages will be injected here -->
      </div>
      <div class="chat-form-container">
        <form id="chat-form">
          <div class="input-group">
            <input
              type="text"
              id="user-input"
              placeholder="Type your message..."
              required
            />
            <button type="submit">Send</button>
          </div>
          <div class="model-input-container">
            <label for="model-id">Select Model:</label>
            <select
              id="model-id"
              class="w-full mt-1 p-2 border border-gray-300 rounded-md"
            >
              <option value="deepseek/deepseek-r1-0528:free">
                DeepSeek R1
              </option>
              <option value="deepseek/deepseek-chat-v3-0324:free">
                DeepSeek Chat
              </option>
              <option value="qwen/qwen3-coder:free">Qwen Coder</option>
              <option
                value="cognitivecomputations/dolphin-mistral-24b-venice-edition:free"
              >
                Dolphin Mistral
              </option>
              <option value="tngtech/deepseek-r1t2-chimera:free">
                DeepSeek R1T2 Chimera
              </option>
            </select>
          </div>
        </form>
      </div>
    </div>

    <script>
      let conversationHistory = [];

      const chatHistoryEl = document.getElementById("chat-history");
      const chatFormEl = document.getElementById("chat-form");
      const userInputEl = document.getElementById("user-input");
      const modelNameEl = document.getElementById("model-id");
      const endpoint = "http://localhost:8080/generate";

      // Function to display a message in the chat UI
      function displayMessage(text, role) {
        const messageEl = document.createElement("div");
        messageEl.classList.add("message");
        if (role === "user") {
          messageEl.classList.add("user-message");
          messageEl.textContent = text;
        } else {
          messageEl.classList.add("ai-message");
          // Use marked.js to convert Markdown to HTML
          messageEl.innerHTML = marked.parse(text);
        }
        chatHistoryEl.appendChild(messageEl);
        // Auto-scroll to the bottom of the chat history
        chatHistoryEl.scrollTop = chatHistoryEl.scrollHeight;
      }

      // Function to show a typing indicator
      function showTypingIndicator() {
        const typingIndicatorEl = document.createElement("div");
        typingIndicatorEl.id = "typing-indicator";
        typingIndicatorEl.classList.add("typing-indicator");
        typingIndicatorEl.textContent = "AI is thinking...";
        chatHistoryEl.appendChild(typingIndicatorEl);
        chatHistoryEl.scrollTop = chatHistoryEl.scrollHeight;
      }

      // Function to remove the typing indicator
      function removeTypingIndicator() {
        const typingIndicatorEl = document.getElementById("typing-indicator");
        if (typingIndicatorEl) {
          typingIndicatorEl.remove();
        }
      }

      // Event listener for the form submission
      chatFormEl.addEventListener("submit", async (e) => {
        e.preventDefault();

        const userQuestion = userInputEl.value.trim();
        if (!userQuestion) {
          return;
        }

        // Add user's message to the history and display it
        conversationHistory.push({ role: "user", content: userQuestion });
        displayMessage(userQuestion, "user");
        userInputEl.value = "";

        // Show a typing indicator while waiting for the response
        showTypingIndicator();

        try {
          // Construct the payload with the entire conversation history
          const payload = {
            messages: conversationHistory.map((msg) => ({
              role: msg.role === "user" ? "user" : "assistant",
              content: msg.content,
            })),
            // Add the optional model field if provided
            ...(modelNameEl.value.trim() && {
              modelId: modelNameEl.value.trim(),
            }),
          };

          const response = await fetch(endpoint, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(payload),
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const aiResponseText = await response.text();

          // Add the AI's message to the history and display it
          conversationHistory.push({
            role: "assistant",
            content: aiResponseText,
          });
          displayMessage(aiResponseText, "ai");
        } catch (error) {
          console.error("Error fetching AI response:", error);
          displayMessage(
            "Sorry, something went wrong. Please try again.",
            "ai"
          );
        } finally {
          // Always remove the typing indicator
          removeTypingIndicator();
        }
      });
    </script>
  </body>
</html>
